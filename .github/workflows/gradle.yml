name: Java CI with Gradle

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Restore Gradle Wrapper if missing
        run: |
          # Проверяем и восстанавливаем необходимые файлы
          if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "Downloading missing gradle-wrapper.jar..."
            mkdir -p gradle/wrapper
            curl -L --retry 3 --retry-delay 5 https://repo.maven.apache.org/maven2/org/gradle/gradle-wrapper/8.5/gradle-wrapper-8.5.jar -o gradle/wrapper/gradle-wrapper.jar
          fi
          
          # Проверяем gradle-wrapper.properties
          if [ ! -f "gradle/wrapper/gradle-wrapper.properties" ]; then
            echo "Creating missing gradle-wrapper.properties..."
            mkdir -p gradle/wrapper
            echo "distributionBase=GRADLE_USER_HOME
  distributionPath=wrapper/dists
  distributionUrl=https\://services.gradle.org/distributions/gradle-8.5-bin.zip
  networkTimeout=10000
  validateDistributionUrl=true
  zipStoreBase=GRADLE_USER_HOME
  zipStorePath=wrapper/dists" > gradle/wrapper/gradle-wrapper.properties
  fi

- name: Grant execute permission for gradlew
  run: chmod +x gradlew

- name: Build project first
  run: ./gradlew assemble --no-daemon

- name: Start SUT
  # Запускаем SUT в фоновом режиме
  run: |
    # Ищем JAR файл
    JAR_FILE=""
    if [ -f "./artifacts/app-replan-delivery.jar" ]; then
      JAR_FILE="./artifacts/app-replan-delivery.jar"
    elif [ -f "./artifacts/app-delivery.jar" ]; then
      JAR_FILE="./artifacts/app-delivery.jar"
    else
      # Ищем любой JAR в artifacts
      JAR_FILE=$(find ./artifacts -name "*.jar" -type f | head -1)
    fi
    
    if [ -z "$JAR_FILE" ]; then
      echo "ERROR: No JAR file found in artifacts/"
      find . -name "*.jar" -type f
      exit 1
    fi
    
    echo "Starting SUT from: $JAR_FILE"
    java -jar "$JAR_FILE" --server.port=9999 &
    
    # Ждем запуска сервера
    echo "Waiting for server to start..."
    for i in {1..30}; do
      if curl -s http://localhost:9999 > /dev/null 2>&1; then
        echo "Server started successfully after $i seconds"
        break
      fi
      sleep 1
      if [ $i -eq 30 ]; then
        echo "ERROR: Server failed to start after 30 seconds"
        exit 1
      fi
    done

- name: Build with Gradle
  # Запускаем автотесты с headless режимом
  run: ./gradlew test --info -Dselenide.headless=true --no-daemon